@page "/"

@using Domain.Configuration
@using Domain.Configuration.Interfaces
@inject IParametersService ParametersService

<h3>Настройки</h3>

@if (_model is null)
{
    <p>Загрузка...</p>
}
else
{
    <EditForm Model="_model" OnValidSubmit="OnSaveAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <fieldset>
            <legend>Центральный сервер</legend>
            <div class="mb-2">
                <label>Адрес</label>
                <InputText class="form-control" @bind-Value="_model.CentralServerSettings.Address" />
            </div>
            <div class="mb-2">
                <label>Токен</label>
                <InputText class="form-control" @bind-Value="_model.CentralServerSettings.Token" />
            </div>
            <div class="mb-2">
                <label>Скачивать новую версию</label>
                <InputCheckbox class="form-check-input" @bind-Value="_model.CentralServerSettings.DownloadNewVersion" />
            </div>
        </fieldset>
        
        <fieldset>
            <legend>Основная база данных Frontol</legend>
            <div class="mb-2">
                <label>Путь к Main.gdb</label>
                <InputText class="form-control" @bind-Value="_model.DatabaseConnection.DatabasePath" />
            </div>
            <div class="mb-2">
                <label>Пользователь</label>
                <InputText class="form-control" @bind-Value="_model.DatabaseConnection.UserName" />
            </div>
            <div class="mb-2">
                <label>Пароль</label>
                <InputText class="form-control" type="password" @bind-Value="_model.DatabaseConnection.Password" />
            </div>
        </fieldset>

        <fieldset>
            <legend>Логирование</legend>
            <div class="form-check mb-2">
                <InputCheckbox class="form-check-input" id="logEnabled" @bind-Value="_model.LoggerSettings.IsEnabled" />
                <label class="form-check-label" for="logEnabled">Включить логирование</label>
            </div>
            <div class="mb-2">
                <label>Уровень логирования</label>
                <InputSelect class="form-control" @bind-Value="_model.LoggerSettings.LogLevel">
                    @foreach (var level in _logLevels)
                    {
                        <option value="@level">@level</option>
                    }
                </InputSelect>
            </div>
            <div class="mb-2">
                <label>Глубина (дней)</label>
                <InputNumber class="form-control" @bind-Value="_model.LoggerSettings.LogDepth" />
            </div>
        </fieldset>

        <fieldset>
            <legend>Локальный сервер</legend>
            <div class="mb-2">
                <label>Порт API</label>
                <InputNumber class="form-control" @bind-Value="_model.ServerSettings.ApiIpPort" />
            </div>
        </fieldset>

        <button class="btn btn-primary" type="submit" >Сохранить</button>

        @if (!string.IsNullOrWhiteSpace(_message))
        {
            <div class="mt-3">@_message</div>
        }
    </EditForm>
}

@code {
    private Parameters? _model;
    private string? _message;
    private readonly string[] _logLevels = ["Verbose", "Debug", "Information", "Warning", "Error", "Fatal"];

    protected override async Task OnInitializedAsync()
    {
        _model = await ParametersService.Current();
    }

    private async Task OnSaveAsync()
    {
        if (_model is null)
        {
            _message = "Модель не загружена.";
            return;
        }

        _message = null;

        try
        {
            var saved = await ParametersService.Update(_model);
            _message = saved ? "Настройки сохранены." : "Не удалось сохранить настройки.";
        }
        catch (Exception ex)
        {
            _message = $"Ошибка: {ex.Message}";
        }
    }
}